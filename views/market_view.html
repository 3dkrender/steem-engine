<div class="mt-3">
	<div class="row">
		<div class="col-md-12 text-center">
			<h4 class="font-weight-bold">Market Depth (<%= data.token %>)</h4>
			<div class="chart-container">
				<canvas id="market_depth_chart"></canvas>
			</div>
		</div>
	</div>

	<!-- buy/sell forms -->
	<% if(SE.User) { %>
		<div class="row">
			<div class="col-md-6 text-left p-3 buy-form">
				<h4 class="font-weight-bold">Buy <%= data.token %></h4>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Price</label>
						<input type="number" id="buyPrice" placeholder="0.0" class="text-right" style="width: 180px;">
						<div class="input-group-append">
							<span class="input-group-text">Steem/<%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Quantity</label>
						<input type="number" id="buyQuantity" placeholder="1" class="text-right" style="width: 180px;">
						<div class="input-group-append">
							<span class="input-group-text"><%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Total</label>
						<input type="number" id="buyTotal" placeholder="0.0" class="text-right" style="width: 180px;" readonly disabled>
						<div class="input-group-append">
							<span class="input-group-text">Steem</span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group text-center mt-1">
					<button class="btn btn-primary btn-sm" onclick="btnSubmitOrder('buy');" style="margin: auto;">Buy <%= data.token %></button>
				</div>
			</div>
			<div class="col-md-6 text-left p-3 sell-form">
				<h4 class="font-weight-bold">Sell <%= data.token %></h4>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Price</label>
						<input type="number" id="sellPrice" placeholder="0.0" class="text-right" style="width: 180px;">
						<div class="input-group-append">
							<span class="input-group-text">Steem/<%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Quantity</label>
						<input type="number" id="sellQuantity" placeholder="1" class="text-right" style="width: 180px;">
						<div class="input-group-append">
							<span class="input-group-text"><%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 90px;">Total</label>
						<input type="number" id="sellTotal" placeholder="0.0" class="text-right" style="width: 180px;" readonly disabled>
						<div class="input-group-append">
							<span class="input-group-text">Steem</span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group text-center mt-1">
					<button class="btn btn-primary btn-sm" onclick="btnSubmitOrder('sell');" style="margin: auto;">Sell <%= data.token %></button>
				</div>
			</div>
		</div>
	<% } %>

	<!-- active buy/sell orders -->
	<div class="row">
		<div class="col-md-6 text-left p-3">
			<h4 class="font-weight-bold">Buy Orders</h4>
			<table id="buy_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
		<div class="col-md-6 text-left p-3">
			<h4 class="font-weight-bold">Sell Orders</h4>
			<table id="sell_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
	</div>

	<!-- your orders -->
	<% if(SE.User) { %>
	<div class="row">
		<div class="col-md-12 text-left p-3">
			<h4 class="font-weight-bold">Open Orders</h4>
			<table id="user_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
	</div>
	<% } %>
</div>

<script>
	var data = <%= JSON.stringify(data) %>;
	function OrderTypeColumn(value, options, rowdata) { return value.toUpperCase(); }
	function OrderAmountColumn(value, options, rowdata) { return value.toFixed(data.precision); }
	function UpdateOrderTotal(type) {
		var price = parseFloat($("#" + type + "Price").val());
		var quantity = parseFloat($("#" + type + "Quantity").val());

		if (price && price > 0 && quantity && quantity > 0) {
			$("#" + type + "Total").val(price * quantity);
		}
	}
	function UpdateBuyOrderTotal() { return UpdateOrderTotal('buy') }
	function UpdateSellOrderTotal() { return UpdateOrderTotal('sell') }

	console.log(data);

	$("#buyPrice").change(UpdateBuyOrderTotal);
	$("#buyQuantity").change(UpdateBuyOrderTotal);

	$("#sellPrice").change(UpdateSellOrderTotal);
	$("#sellQuantity").change(UpdateSellOrderTotal);

	$('#user_order_table').footable({
		"columns": [
			{ "name": "timestamp_string", "title": "Date Created" },
			{ "name": "txId", "title": "ID" },
			{ "name": "type", "title": "Type", "formatter": OrderTypeColumn },
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" },
			{ "name": "quantity", "title": data.token + " (Qty)", "classes": "text-right" },
			{ "name": "total", "title": "Steem", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "action", "title": "Action", "classes": "text-center", "formatter": function (value, options, rowdata) {
        	var actions = $('<div/>')

					var cancelButton = ($('<button/>', {'class':'btn btn-danger btn-sm'})
						.append('<span>Cancel</span>')
						.on("click", this, function () {
							console.log(rowdata);
							btnCancelOrder(rowdata.type, rowdata.txId);
						}))
						.appendTo(actions);

				  return actions;
				}
			}
		],
		"rows": data.user_orders
	});

	$('#buy_order_table').footable({
		"columns": [
			{ "name": "total", "title": "Total STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "amountLocked", "title": "STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "quantity", "title": data.token + " (Qty)", "type": "number", "classes": "text-right" },
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" }
		],
		"rows": data.buy_orders.slice(0, 15)
	});

	$('#sell_order_table').footable({
		"columns": [
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" },
			{ "name": "quantity", "title": data.token + " (Qty)", "type": "number", "classes": "text-right" },
			{ "name": "amountLocked", "title": "STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "total", "title": "Total STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn }
		],
		"rows": data.sell_orders.slice(0, 15)
	});

	// chart
	var prices = data.buy_orders.map(o => o.price).concat(data.sell_orders.map(o => o.price));
	var labels = _.sortedUniq(prices);

	var buyOrderDataset = [];
	var sellOrderDataset = [];
	labels.forEach(label => {
		let matchingBuyOrders = data.buy_orders.filter(o => o.price === label);
		if (matchingBuyOrders.length === 0) {
			buyOrderDataset.push(null);
		} else {
			buyOrderDataset.push(matchingBuyOrders.reduce((acc, val) => val.price * val.quantity , 0));
		}

		let matchingSellOrders = data.sell_orders.filter(o => o.price === label);
		if (matchingSellOrders.length === 0) {
			sellOrderDataset.push(null);
		} else {
			sellOrderDataset.push(matchingSellOrders.reduce((acc, val) => val.price * val.quantity , 0));
		}
	});

	var chart_ctx = $("#market_depth_chart");
	var market_chart = new Chart(chart_ctx, {
		type: 'line',
		legend: {
			display: false
		},
		data: {
			labels: labels,
			datasets: [
				{
					label: 'Buy',
					steppedLine: 'before',
					borderColor: '#88e86b',
					backgroundColor: '#a9ea96',
					data: buyOrderDataset
				},
				{
					label: 'Sell',
					steppedLine: 'before',
					borderColor: '#e45858',
					backgroundColor: '#e87f7f',
					data: sellOrderDataset
				}
			]
		},
		options: {
			steppedLine: true
		}
	});

	function btnSubmitOrder(type) {
		if (type !== 'buy' && type !== 'sell') {
			console.error('Invalid order type: ', type)
			return;
		}

		let isValid = true;
		$('.' + type + '-form input').removeClass("is-invalid");

    var price = parseFloat($("#" + type + "Price").val());
    var quantity = parseFloat($("#" + type + "Quantity").val());

    if(isNaN(price) || price <= 0) {
      $('#' + type + 'Price').addClass("is-invalid");
      isValid = false;
		}

		if(isNaN(quantity) || quantity <= 0) {
      $('#' + type + 'Quantity').addClass("is-invalid");
      isValid = false;
		}

    if(isValid) {
      // show confim dialog
			SE.ShowMarketOrderDialog(type, data.token, quantity, price);
    }
	}

	function btnCancelOrder(type, txId) {
		if (type !== 'buy' && type !== 'sell') {
			console.error('Invalid order type: ', type)
			return;
		}

		SE.ShowMarketCancelDialog(type, txId);
	}
</script>