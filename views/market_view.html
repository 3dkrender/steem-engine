<div class="mt-3">
	<div class="row">
		<div class="col-md-12 text-center">
			<h4 class="font-weight-bold">Market Depth (<%= data.token %>)</h4>
			<div class="chart-container">
				<canvas id="market_depth_chart"></canvas>
			</div>
		</div>
	</div>

	<!-- buy/sell forms -->
	<% if(SE.User) { %>
		<div class="row">
			<div class="col-md-6 text-left p-3 buy-form">
				<h4 class="font-weight-bold">Buy <%= data.token %></h4>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Price</label>
						<input type="number" id="buyPrice">
						<div class="input-group-append">
							<span class="input-group-text">Steem/<%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Amount</label>
						<input type="number" id="buyAmount">
						<div class="input-group-append">
							<span class="input-group-text"><%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Total</label>
						<input type="number" id="buyTotal">
						<div class="input-group-append">
							<span class="input-group-text">Steem</span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group text-center mt-1">
					<button class="btn btn-primary btn-sm" onclick="btnSubmitBuy();" style="margin: auto;">Buy <%= data.token %></button>
				</div>
			</div>
			<div class="col-md-6 text-left p-3 sell-form">
				<h4 class="font-weight-bold">Sell <%= data.token %></h4>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Price</label>
						<input type="number" id="sellPrice">
						<div class="input-group-append">
							<span class="input-group-text">Steem/<%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Amount</label>
						<input type="number" id="sellAmount">
						<div class="input-group-append">
							<span class="input-group-text"><%= data.token %></span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group">
					<div class="input-group mb-1">
						<label style="min-width: 80px;">Total</label>
						<input type="number" id="sellTotal">
						<div class="input-group-append">
							<span class="input-group-text">Steem</span>
						</div>
						<div class="invalid-feedback">
							Required field. Price must be a number greater than 0.
						</div>
					</div>
				</div>
				<div class="group text-center mt-1">
					<button class="btn btn-primary btn-sm" onclick="btnSubmitSell();" style="margin: auto;">Sell <%= data.token %></button>
				</div>
			</div>
		</div>
	<% } %>

	<!-- active buy/sell orders -->
	<div class="row">
		<div class="col-md-6 text-left p-3">
			<h4 class="font-weight-bold">Buy Orders</h4>
			<table id="buy_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
		<div class="col-md-6 text-left p-3">
			<h4 class="font-weight-bold">Sell Orders</h4>
			<table id="sell_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
	</div>

	<!-- your orders -->
	<% if(SE.User) { %>
	<div class="row">
		<div class="col-md-12 text-left p-3">
			<h4 class="font-weight-bold">Open Orders</h4>
			<table id="user_order_table" class="tokensTable interactiveTable" data-sorting="true"></table>
		</div>
	</div>
	<% } %>
</div>

<script>
	var data = <%= JSON.stringify(data) %>;
	function OrderTypeColumn(value, options, rowdata) { return value.toUpperCase(); }
	function OrderAmountColumn(value, options, rowdata) { return value.toFixed(data.precision); }
	console.log(data);

	$('#user_order_table').footable({
		"columns": [
			{ "name": "timestamp_string", "title": "Date Created" },
			{ "name": "type", "title": "Type", "formatter": OrderTypeColumn },
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" },
			{ "name": "quantity", "title": data.token + " (Qty)", "classes": "text-right" },
			{ "name": "total", "title": "Steem", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "action", "title": "Action" }
		],
		"rows": data.user_orders
	});

	$('#buy_order_table').footable({
		"columns": [
			{ "name": "total", "title": "Total STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "amountLocked", "title": "STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "quantity", "title": data.token + " (Qty)", "type": "number", "classes": "text-right" },
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" }
		],
		"rows": data.buy_orders.slice(0, 15)
	});

	$('#sell_order_table').footable({
		"columns": [
			{ "name": "price", "title": "Price", "type": "number", "classes": "text-right" },
			{ "name": "quantity", "title": data.token + " (Qty)", "type": "number", "classes": "text-right" },
			{ "name": "amountLocked", "title": "STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn },
			{ "name": "total", "title": "Total STEEM", "type": "number", "classes": "text-right", "formatter": OrderAmountColumn }
		],
		"rows": data.sell_orders.slice(0, 15)
	});

	// chart
	var prices = data.buy_orders.map(o => o.price).concat(data.sell_orders.map(o => o.price));
	var labels = _.sortedUniq(prices);

	var buyOrderDataset = [];
	var sellOrderDataset = [];
	labels.forEach(label => {
		let matchingBuyOrders = data.buy_orders.filter(o => o.price === label);
		if (matchingBuyOrders.length === 0) {
			buyOrderDataset.push(null);
		} else {
			buyOrderDataset.push(matchingBuyOrders.reduce((acc, val) => val.price * val.quantity , 0));
		}

		let matchingSellOrders = data.sell_orders.filter(o => o.price === label);
		if (matchingSellOrders.length === 0) {
			sellOrderDataset.push(null);
		} else {
			sellOrderDataset.push(matchingSellOrders.reduce((acc, val) => val.price * val.quantity , 0));
		}
	});

	var chart_ctx = $("#market_depth_chart");
	var market_chart = new Chart(chart_ctx, {
		type: 'line',
		legend: {
			display: false
		},
		data: {
			labels: labels,
			datasets: [
				{
					label: 'Buy',
					steppedLine: 'before',
					borderColor: '#88e86b',
					backgroundColor: '#a9ea96',
					data: buyOrderDataset
				},
				{
					label: 'Sell',
					steppedLine: 'before',
					borderColor: '#e45858',
					backgroundColor: '#e87f7f',
					data: sellOrderDataset
				}
			]
		},
		options: {
			steppedLine: true
		}
	});

	function btnSubmitBuy() {
    var price = parseFloat($("#buyPrice").val());
    var amount = parseFloat($("#buyAmount").val());
    var total = parseFloat($("#buyTotal").val());

    if(isNaN(price) || price <= 0) {
      $('#buyPrice').addClass("is-invalid");
      isValid = false;
		}

		if(isNaN(amount) || amount <= 0) {
      $('#buyAmount').addClass("is-invalid");
      isValid = false;
		}

		if(isNaN(total) || total <= 0) {
      $('#buyTotal').addClass("is-invalid");
      isValid = false;
		}

    if(isValid) {
      $('.buy-form input').removeClass("is-invalid");

			// TODO: show confim dialog
			// SE.ShowConfirmAddToken(tokenName, symbol, precision, maxSupply, url);
    }
	}

	function btnSubmitSell() {
    var price = parseFloat($("#sellPrice").val());
    var amount = parseFloat($("#sellAmount").val());
    var total = parseFloat($("#sellTotal").val());

    if(isNaN(price) || price < 0) {
      $('#sellPrice').addClass("is-invalid");
      isValid = false;
		}

		if(isNaN(amount) || amount < 0) {
      $('#sellAmount').addClass("is-invalid");
      isValid = false;
		}

		if(isNaN(total) || total < 0) {
      $('#sellTotal').addClass("is-invalid");
      isValid = false;
		}

    if(isValid) {
      $('.sell-form input').removeClass("is-invalid");

			// TODO: show confim dialog
			// SE.ShowConfirmAddToken(tokenName, symbol, precision, maxSupply, url);
    }
  }
</script>